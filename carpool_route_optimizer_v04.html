<!DOCTYPE html>
<html>
	<head>
		<title>Carpool Route Optimizer</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">
		<style type="text/css">
			html { height: 100% }
			body { height: 100%; margin: 0; padding: 0 }
			#map_canvas { height: 100% }
		</style>
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDyYKJ4DTfd0j3cngEOWU34SYDIZ7pvzpg&sensor=false"></script>
		<script>
      		var directionDisplay;
      		var directionsService = new google.maps.DirectionsService();
      		var map;

      		function initialize() {
        		directionsDisplay = new google.maps.DirectionsRenderer();
        		var home = new google.maps.LatLng(32.8350,-116.7656); //Alpine, CA
        		var mapOptions = {
          			zoom: 10,
          			mapTypeId: google.maps.MapTypeId.ROADMAP,
          			center: home
        			}
        		map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
        		directionsDisplay.setMap(map);
      			}

      		function calcRoute() {
				var distance = [];
				var end = document.getElementById('end').value;
				var riders = document.getElementById('riders');
				
				//Create selected riders array
				var num = 0;
				var selected_riders = new Object();
				console.log(["length of riders is ",riders.length]);
				for (var i = 0; i < riders.length; i++) {
					if (riders.options[i].selected == true) {
           			selected_riders[num] = riders.options[i].value;
						num++;
      					}
					}
				console.log(["num is ",num]);
				
				//Calculate distances of all routes
				for (var i = 0; i < num; i++) {
					console.log("i = ",i);
					var waypts = [];
					var start = selected_riders[i];
					for (var j = 0; j < num; j++) {
						if ( j !== i ) {  //Do not add start to waypoints
            				waypts.push({
                				location:selected_riders[j],
                				stopover:true});
          					}
						}
					console.log(["start  = ", start]);
					console.log(["rider1 = ", waypts[0].location]);
					console.log(["rider2 = ", waypts[1].location]);
					console.log(["end    = ", end]);
					var request = {
   	       	  		origin: start,
   		         		destination: end,
   		         		waypoints: waypts,
       	     		optimizeWaypoints: true,
          		  		travelMode: google.maps.DirectionsTravelMode.DRIVING,
        				};
					directionsService.route(request, function(response, status) {
						if (status !== google.maps.DirectionsStatus.OK){
							alert("DirectionsStatus not OK!");
							}
						else{
							var route = response.routes[0];
							distance[i] = 0;
   	         				for (var j = 0; j < route.legs.length; j++) {
								distance[i] = distance[i] + route.legs[j].distance.value;
   								}
							distance[i] = distance[i]/1609.34;  //Convert from meters to miles
							console.log(["distance is ",distance[i]]);
							}
						});				
					}
				pausecomp(2000);
				console.log(["distance is ",distance]);
				
				//Determine best route (shortest distance)
				var best = 0;
				for (var i = 0; i <= 3; i++) {
					if (distance[best] < distance[i]) {
						best = i;
						}
					console.log(["distance[i] is ",distance[i]]);
					console.log(["minimum distance is ",distance.min()]);
					}
				console.log("best is ",best);

				//Recalculate best route and display
				var waypts = [];
				var start = riders[best].value;
				for (var j = 0; j < riders.length; j++) {
					if ( j !== best ) {  //Do not add driver to waypoints
						if (riders.options[j].selected == true) {
            				waypts.push({
                				location:riders[j].value,
                				stopover:true});
          					}
						}
					}
				var request = {
   	      	  		origin: start,
   		      		destination: end,
   		       	waypoints: waypts,
       	     	optimizeWaypoints: true,
          			travelMode: google.maps.DirectionsTravelMode.DRIVING,
        			};
				directionsService.route(request, function(response, status) {
          			if (status == google.maps.DirectionsStatus.OK) {
            			directionsDisplay.setDirections(response);
            			var route = response.routes[0];
						var totaldist = 0;
            			var summaryPanel = document.getElementById('directions_panel');
            			summaryPanel.innerHTML = '';
            			// For each route, display summary information.
            			for (var i = 0; i < route.legs.length; i++) {
              			var routeSegment = i + 1;
              			summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment + '</b><br>';
              			summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
              			summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
              			summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
							totaldist = totaldist + route.legs[i].distance.value;
            				}
						totaldist = totaldist/1609.34;  //Convert from meters to miles
						summaryPanel.innerHTML += '<b>Total Distance: </b>' + totaldist.toFixed(1) + ' miles<br><br>';
          				}
        			});
				}
				
			function pausecomp(millis) {
				var date = new Date();
				var curDate = null;
				do { curDate = new Date(); } 
				while(curDate-date < millis);
			}
			 
		</script>
	</head>

	<body onload="initialize()">
    		<div id="map_canvas" style="float:left;width:70%;height:100%;"></div>
    		<div id="control_panel" style="float:right;width:30%;text-align:left;padding-top:20px">
    		<div style="margin:20px;border-width:2px;">
	    		<b>Carpool Route Optimizer v0.4</b><br>
			Written by James Harper<br><br>
			<b>Riders</b> <br>
    			<i>(Ctrl-Click for multiple selection)</i> <br>
	    		<select multiple id="riders">
	      		<option value="1122 Washington Place, 92103">James Harper</input>
	      		<option value="1030 Robinson Ave, 92103">Jennifer Fouquier</input>
	      		<option value="7245 Canyon Breeze Road, 92126">Elise Minda</input>
	      		<option value="10711 Calston Way, 92126">Nazli Taheri</input>
				<option value="3009 Union Street #18, 92103">Tony Rolfe</input>
	    		</select>
			<br><br>
	    		<b>Destination:</b>
	    		<select id="end">
	      		<option value="Mission Trails Visitor Center, 92119">Mission Trails Visitor Center</option>
	      		<option value="San Ysidro Border, Bursátil, Tijuana, Mexico">Tijuana</option>
	      		<option value="Ocean Beach, CA">Ocean Beach</option>
	      		<option value="4545 La Jolla Village Drive, 92122">UTC</option>
	    		</select>
	    		<br><br>
	      	<input type="submit" onclick="calcRoute();">
    		</div>
    		<div id="directions_panel" style="margin:20px;background-color:#FFEE77;"></div>
    		</div>
  	</body>
</html>