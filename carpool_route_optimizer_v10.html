<!DOCTYPE html>
<html>
	<head>
		<title>Carpool Route Optimizer</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">
		<style type="text/css">
			html { height: 100% }
			body { height: 100%; margin: 0; padding: 0 }
			#map_canvas { height: 100% }
		</style>
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDyYKJ4DTfd0j3cngEOWU34SYDIZ7pvzpg&sensor=false"></script>
		<script>
      		var map;
      		var geocoder;
      		var bounds = new google.maps.LatLngBounds();
      		var markersArray = [];
      		var destinationIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=D|FF0000|000000';
      		var originIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=O|FFFF00|000000';

      		function initialize() {
        		var opts = {
          			center: new google.maps.LatLng(32.8350,-116.7656),  //Alpine, CA
          			zoom: 10,
          			mapTypeId: google.maps.MapTypeId.ROADMAP
        		};
        		map = new google.maps.Map(document.getElementById('map'), opts);
        		geocoder = new google.maps.Geocoder();
      		}

			function calculateDistances() {
				var service = new google.maps.DistanceMatrixService();
				
				//Create selected riders array
				var num = 0;  //Number of selected riders
				var selected_riders = new Object();
				console.log(["length of riders is ",riders.length]);
				for (var i = 0; i < riders.length; i++) {
					if (riders.options[i].selected == true) {
           			selected_riders[num] = riders.options[i].value;
						num++;
      				}
				}
				console.log(["number of selected riders (num) is ",num]);
				
				switch(num)
				case 2:
					alert("2 riders");
				case 3:
					alert("3 riders");
					service.getDistanceMatrix( {
       				origins: [selected_riders[0], selected_riders[1], selected_riders[2]],
            			destinations: [selected_riders[0], selected_riders[1], selected_riders[2], end],
            			travelMode: google.maps.TravelMode.DRIVING,
            			unitSystem: google.maps.UnitSystem.IMPERIAL,
            			avoidHighways: false,
            			avoidTolls: false
          			}, callback);
				case 4:
					alert("4 riders");
				case 5:
					alert("5 riders");
				case 6:
					alert("6 riders");
					
        		service.getDistanceMatrix( {
       			origins: [origin1, origin2],
            		destinations: [destinationA, destinationB],
            		travelMode: google.maps.TravelMode.DRIVING,
            		unitSystem: google.maps.UnitSystem.METRIC,
            		avoidHighways: false,
            		avoidTolls: false
          		}, callback);
      		}

      		function callback(response, status) {
        		if (status != google.maps.DistanceMatrixStatus.OK) {
          			alert('Error was: ' + status);
        		} else {
          			var origins = response.originAddresses;
          			var destinations = response.destinationAddresses;
          			var outputDiv = document.getElementById('outputDiv');
          			outputDiv.innerHTML = '';
          			deleteOverlays();

          			for (var i = 0; i < origins.length; i++) {
            			var results = response.rows[i].elements;
            			addMarker(origins[i], false);
            			for (var j = 0; j < results.length; j++) {
              			addMarker(destinations[j], true);
              			outputDiv.innerHTML += origins[i] + ' to ' + destinations[j] + ': ' + results[j].distance.text + ' in ' + results[j].duration.text + '<br>';
            			}
          			}
        		}
      		}

      		function addMarker(location, isDestination) {
        		var icon;
        		if (isDestination) {
          			icon = destinationIcon;
        		} else {
          			icon = originIcon;
        		}
        		geocoder.geocode({'address': location}, function(results, status) {
          			if (status == google.maps.GeocoderStatus.OK) {
            			bounds.extend(results[0].geometry.location);
            			map.fitBounds(bounds);
            			var marker = new google.maps.Marker({
              			map: map,
              			position: results[0].geometry.location,
              			icon: icon
            			});
            			markersArray.push(marker);
          			} else {
            			alert('Geocode was not successful for the following reason: ' + status);
          			}
        		});
      		}

      function deleteOverlays() {
        if (markersArray) {
          for (i in markersArray) {
            markersArray[i].setMap(null);
          }
          markersArray.length = 0;
        }
      }















      		

      		function calcRoutes() {
				var end = document.getElementById('end').value;
				var riders = document.getElementById('riders');
				
				
				
				//Calculate distances of all routes
				var count = 0;
				var start_shortest;
				var waypts_shortest;
				var end_shortest;
				var distance_shortest = 99999999999; //meters
				for (var i = 0; i < num; i++) {
					count++
					console.log(["i = ",i]);
					var waypts = [];
					var start = selected_riders[i];
					for (var j = 0; j < num; j++) { //Create waypoint array
						if ( j !== i ) {  //Do not add start to waypoints
            				waypts.push({
                				location:selected_riders[j],
                				stopover:true
								});
          					}
						}
					console.log(["start  = ", start]);
					for (var j = 0; j < num-1; j++) {
						console.log(["rider",j+1," = ", waypts[j].location]);
						}
					console.log(["end    = ", end]);
					var request = {
   	       	  		origin: start,
   		         		destination: end,
   		         		waypoints: waypts,
       	     		optimizeWaypoints: true,
          		  		travelMode: google.maps.DirectionsTravelMode.DRIVING,
        				};
					directionsService.route(request, function(response, status) {
						if (status == google.maps.DirectionsStatus.OK) {
							console.log("DirectionsStatus OK");
							var distance = 0;
   	         				for (var j = 0; j < response.routes[0].legs.length; j++) {  //Calculate distance of route
								distance = distance + response.routes[0].legs[j].distance.value;
   								}
							console.log(["distance is ",distance," in meters"]);
							console.log(["distance_shortest is ",distance_shortest]);
							if (distance < distance_shortest) { //Record shortest route information, if required
          	             		start_shortest = start;
								waypts_shortest = waypts;
								end_shortest = end;
                       		distance_shortest = distance;
								}
							console.log(["distance_shortest is ",distance_shortest]);
							console.log(["i = ",i]);
							console.log(["count = ",count]);
							console.log(["num = ",num]);
							if (count == num ) {  //If all routes have been calculated
								console.log(["start is ",start_shortest]);
								console.log(["waypts is ",waypts_shortest]);
								console.log(["end is ",end_shortest]);
          						calcShortestRoute(start_shortest, waypts_shortest, end_shortest, distance_shortest, num);
        						}
							}
						});
					}
				}
					

			function calcShortestRoute(start, waypts, end, distance_shortest, num) {
				console.log(["start  = ", start]);
				for (var j = 0; j < num-1; j++) {
						console.log(["rider",j+1," = ", waypts[j].location]);
						}
				console.log(["end    = ", end]);
				var request = {
   	      	  		origin: start,
   		      		destination: end,
   		       	waypoints: waypts,
       	     	optimizeWaypoints: true,
          			travelMode: google.maps.DirectionsTravelMode.DRIVING,
        			};
				directionsService.route(request, function(response, status) {
          			if (status == google.maps.DirectionsStatus.OK) {
						console.log("DirectionsStatus OK");
						var distance = 0;
            			directionsDisplay.setDirections(response);  //Display route on map
            			var summaryPanel = document.getElementById('directions_panel');  //Update summary panel with route information
            			summaryPanel.innerHTML = '';
            			for (var i = 0; i < response.routes[0].legs.length; i++) {  // For each route segment, display summary information
              			summaryPanel.innerHTML += '<b>Route Segment: ' + (i+1) + '</b><br>';
              			summaryPanel.innerHTML += response.routes[0].legs[i].start_address + ' to ';
              			summaryPanel.innerHTML += response.routes[0].legs[i].end_address + '<br>';
              			summaryPanel.innerHTML += response.routes[0].legs[i].distance.text + '<br><br>';
							distance = distance + response.routes[0].legs[i].distance.value;
            				}
						console.log(["distance is ",distance]);
						console.log(["distance_shortest is ",distance_shortest]);
						distance = distance/1609.34;  //Convert from meters to miles for display
						summaryPanel.innerHTML += '<b>Total Distance: </b>' + distance.toFixed(1) + ' miles<br><br>';
          				}
        			});
				}
						 
		</script>
	</head>

	<body onload="initialize()">
    		<div id="map_canvas" style="float:left;width:70%;height:100%;"></div>
    		<div id="control_panel" style="float:right;width:30%;text-align:left;padding-top:20px">
    		<div style="margin:20px;border-width:2px;">
	    		<b>Carpool Route Optimizer v0.9</b><br>
			Written by James Harper<br><br>
			<b>Riders</b> <br>
    			<i>(Ctrl-Click for multiple selection)</i> <br>
	    		<select multiple id="riders">
	      		<option value="1122 Washington Place, 92103">James Harper</input>
	      		<option value="1030 Robinson Ave, 92103">Jennifer Fouquier</input>
	      		<option value="7245 Canyon Breeze Road, 92126">Elise Minda</input>
	      		<option value="10711 Calston Way, 92126">Nazli Taheri</input>
				<option value="3009 Union Street #18, 92103">Tony Rolfe</input>
	    		</select>
			<br><br>
	    		<b>Destination:</b>
	    		<select id="end">
	      		<option value="Mission Trails Visitor Center, 92119">Mission Trails Visitor Center</option>
	      		<option value="San Ysidro Border, Bursátil, Tijuana, Mexico">Tijuana</option>
	      		<option value="Ocean Beach, CA">Ocean Beach</option>
	      		<option value="4545 La Jolla Village Drive, 92122">UTC</option>
	    		</select>
	    		<br><br>
	      	<input type="submit" onclick="calcRoutes();">
    		</div>
    		<div id="directions_panel" style="margin:20px;background-color:#FFEE77;"></div>
    		</div>
  	</body>
</html>