<!DOCTYPE html>
<html>
	<head>
    		<title>Carpool Route Optimizer v0.1</title>
    		<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    		<style>
			html { height: 100% }
			body { height: 100%; margin: 0; padding: 0 }
			#map { height: 100% }
    	</style>
		<script>
			var directionDisplay;
	      	var directionsService = new google.maps.DirectionsService();
			var map;
			var combos = [];  //combos: Global array which holds the list of permutations of riders (used in function permute)
			var usedChars = [];  //usedChars: Global utility array which holds a list of "currently-in-use" characters (used in function permute)

			function initialize() {
				directionsDisplay = new google.maps.DirectionsRenderer();
				var opts = {
					center: new google.maps.LatLng(32.8350,-116.7656),  //Alpine, CA
  		        	zoom: 10,
  		        	mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				map = new google.maps.Map(document.getElementById('map'), opts);
				directionsDisplay.setMap(map);
			}

			function calculateDistances() {
	  	     	var service = new google.maps.DistanceMatrixService();
				var riders = document.getElementById('riders');
				var end = document.getElementById('end').value;	
				
				//Clear all output panels of previous information
				document.getElementById('directions_panel').innerHTML = "";
				document.getElementById('output_panel').innerHTML = "";
				
				//Create arrays of selected riders and destinations
				var num = 0;
				var selected_riders = [];
				var destinations = [];
				console.log(["riders is ",riders]);
				console.log(["length of riders is ",riders.length]);
				for (var i = 0; i < riders.length; i++) {
					if (riders.options[i].selected == true) {
	  	         		selected_riders[num] = riders.options[i].value;
						destinations[num]    = riders.options[i].value;
						num++;
      					}
					}
				destinations[num] = end;
				console.log(["num is ",num]);
				console.log(["length of selected_riders is ",selected_riders.length]);
				console.log(["selected_riders is ",selected_riders]);
				console.log(["length of destinations is ",destinations.length]);
				console.log(["destinations is ",destinations]);
				request = {
  	          		origins: selected_riders,
  	          		destinations: destinations,
  	          		travelMode: google.maps.TravelMode.DRIVING,
  	          		unitSystem: google.maps.UnitSystem.METRIC,
  	          		avoidHighways: false,
  	          		avoidTolls: false
  	        	}
				console.log(["request is ",request]);
				
				//Get distance matrix from Google Maps and process results in callback function
				service.getDistanceMatrix(request, callback);
			
   		   	}

			function callback(response, status) {		//Process results of distance matrix
				if (status != google.maps.DistanceMatrixStatus.OK) {
  	        		alert('Error was: ' + status);
	  	   			}
				else {
					var origins = response.originAddresses;
					console.log(['origins is ',origins]);
  	        		var destinations = response.destinationAddresses;
  	        		var outputPanel = document.getElementById('output_panel');
  	    			outputPanel.innerHTML = '';

					//Create name-address array
					//namadd = { [Aaron,9765],[Jeff,6777],[Ming,7150],[Jennifer,1030],[James,1122],[Elise,7245],[Anais,3819],[Erin,960], };
					
					//<option value="9765 Mesa Springs Way, 92126"> Aaron Andrews</input>
					//<option value="6777 Saranac Street, 92115"> Jeff Beckman
					//<option value="7150 Shoreline Drive #3314, 92122"> Ming Chuang</input>
		      		//<option value="1030 Robinson Ave, 92103">Jennifer Fouquier</input>
		      		//<option value="1122 Washington Place, 92103">James Harper</input>
		      		//<option value="7245 Canyon Breeze Road, 92126">Elise Minda</input>
					//<option value="3819 Miramar Street, 92037">Anais Orsi</input>
					//<option value="960 Bolex Way, 92078">  Erin Rist
					//<option value="3009 Union Street #18, 92103">Tony Rolfe</input>
		      		//<option value="10711 Calston Way, 92126">Nazli Taheri</input>
					
					
					//Select list of riders based on number of riders
					var combos = new Object();
					var list
					switch (origins.length) {
						case 2: list = '01'; break;
						case 3: list = '012'; break;
						case 4: list = '0123'; break;
						case 5: list = '01234'; break;
						case 6: list = '012345'; break;
						case 7: list = '0123456'; break;
						case 8: list = '01234567'; break;
						case 9: list = '012345678'; break;
						case 10: list = '0123456789'; break;
						default: alert('Please select between 2 and 10 riders.'); break;
					}
					console.log('list is',list);
					console.log('list is type',typeof list);
					
					//Calculate permutations of routes given list of riders
					var run = false;
					if      ( list.length == 0 )  { }  //Can't permute zero drivers
					else if ( list.length > 5 )   { run = confirm("That is a lot of riders! This may take a while.\nAre you sure you want to continue?");}
					else if ( list.length >= 11 ) { alert("That is way too many riders!\nPlease select between 2 and 10 riders.");}
					else 							   run = true;
					if(run) {
						combos = [];
						permute(list);
					}
					
					//Add destination to end of all permutations of routes
					for (var i = 0; i < combos.length; i++ ) { combos[i] = combos[i] + origins.length; }
					console.log('combos is ',combos);
					console.log('length of combos is ',combos.length);
					
					//Parse distance and duration data
					var distance = [];
					var duration = [];
					for ( var i = 0; i < combos.length; i++ ) {
						console.log('i is',i);
						distance[i] = 0;
						duration[i] = 0;
						console.log('distance[i] is',distance[i]);
						console.log('duration[i] is',duration[i]);
						for ( var j = 0; j < list.length; j++ ) {
							console.log('j is',j);
							console.log('combos[i].charAt(j) is',combos[i].charAt(j));
							console.log('combos[i].charAt(j+1) is',combos[i].charAt(j+1));
							distance[i] = distance[i] + response.rows[combos[i].charAt(j)].elements[combos[i].charAt(j+1)].distance.value/1609.34;
							duration[i] = duration[i] + response.rows[combos[i].charAt(j)].elements[combos[i].charAt(j+1)].duration.value/60;
							console.log('distance[i] is',distance[i]);
							console.log('duration[i] is',duration[i]);
						}
					}
					//distance01 = response.rows[0].elements[1].distance.value/1609.34;  duration01 = response.rows[0].elements[1].duration.value/60;  //miles, minutes
					//distance02 = response.rows[0].elements[2].distance.value/1609.34;  duration02 = response.rows[0].elements[2].duration.value/60;  //miles, minutes
					//distance03 = response.rows[0].elements[3].distance.value/1609.34;  duration03 = response.rows[0].elements[3].duration.value/60;  //miles, minutes
					//distance12 = response.rows[1].elements[2].distance.value/1609.34;  duration12 = response.rows[1].elements[2].duration.value/60;  //miles, minutes
					//distance13 = response.rows[1].elements[3].distance.value/1609.34;  duration13 = response.rows[1].elements[3].duration.value/60;  //miles, minutes
					//distance23 = response.rows[2].elements[3].distance.value/1609.34;  duration23 = response.rows[2].elements[3].duration.value/60;  //miles, minutes
					
					//Calcuate distances and durations of all combinations of drivers and riders
					//distance[0] = distance01 + distance12 + distance23;  duration[0] = duration01 + duration12 + duration23;  //0123
					//distance[1] = distance02 + distance12 + distance13;  duration[1] = duration02 + duration12 + duration13;  //0213
					//distance[2] = distance01 + distance02 + distance23;  duration[2] = duration01 + duration02 + duration23;  //1023
					//distance[3] = distance12 + distance02 + distance03;  duration[3] = duration12 + duration02 + duration03;  //1203
					//distance[4] = distance02 + distance01 + distance13;  duration[4] = duration02 + duration01 + duration13;  //2013
					//distance[5] = distance12 + distance01 + distance03;  duration[5] = duration12 + duration01 + duration03;  //2103
					console.log(distance);
					console.log(duration);
					
					//Select shortest route by distance and duration
					var route_shortest_by_distance = 0;
					var route_shortest_by_duration = 0;
					var distance_shortest = 999999999999999;  //miles
					var duration_shortest = 999999999999999;  //minutes
					console.log('distance is ',distance);
					console.log('length of distance is ',distance.length);
					for (var i = 0; i < distance.length; i++ ) {
						if ( distance[i] < distance_shortest ) {
							route_shortest_by_distance = i;
							distance_shortest = distance[i];
							console.log('i is ',i);
							console.log('route_shortest_by_distance is ',route_shortest_by_distance);
							console.log('distance[i] is ',distance[i]);
							console.log('distance_shortest is ',distance_shortest);
						}
						if ( duration[i] < duration_shortest ) {
							route_shortest_by_duration = i;
							duration_shortest = duration[i];
						}
					}
					
					//Request and display shortest route by distance
					var start = origins[combos[route_shortest_by_distance].charAt(0)];
  	      			var end = destinations[combos[route_shortest_by_distance].charAt(origins.length)];
					console.log('length of destinations is ',destinations.length);
					console.log('end is ',end);
					var waypts = [];
					for (var i = 1; i < origins.length; i++) {
						waypts.push({
							location: origins[combos[route_shortest_by_distance].charAt(i)],
							stopover: true
						});
					}
					var request = {
  	        	  		origin: start,
  	          			destination: end,
  	          			waypoints: waypts,
  	          			optimizeWaypoints: true,
  	          			travelMode: google.maps.DirectionsTravelMode.DRIVING,
						provideRouteAlternatives: false
        			};
					console.log('request is ',request);
					var directionsPanel = document.getElementById('directions_panel');
					directionsPanel.innerHTML += '<b>Best Route:</b><br>';
					directionsService.route(request, function(response, status) {
  	        			if (status == google.maps.DirectionsStatus.OK) {
  	          				directionsDisplay.setDirections(response);
  	          				var route = response.routes[0];
							var totaldistance = 0;
							var totalduration = 0;
            				var directionsPanel = document.getElementById('directions_panel');
            				for (var i = 0; i < route.legs.length; i++) {
              				var routeSegment = i + 1;
              				directionsPanel.innerHTML += '<b>Route Segment ' + routeSegment + '</b><br>';
              				directionsPanel.innerHTML += route.legs[i].start_address + ' to ';
              				directionsPanel.innerHTML += route.legs[i].end_address + '<br>';
              				directionsPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
								totaldistance = totaldistance + route.legs[i].distance.value;
								totalduration = totalduration + route.legs[i].duration.value;
            					}
							totaldistance = totaldistance/1609.34;  //Convert from meters to miles
							totalduration = totalduration/60;  //Convert from seconds to minutes
							directionsPanel.innerHTML += '<b>Total Distance: </b>' + totaldistance.toFixed(1) + ' miles<br>';
							directionsPanel.innerHTML += '<b>Total Duration: </b>' + totalduration.toFixed(1) + ' miles<br>';
          					}
        				});

					//Display enumeration of riders
					for (var i = 0; i < origins.length; i++) {
						outputPanel.innerHTML += 'Rider ' + i + ': ' + origins[i] + '<br>';
					}
					
					//Display distances and durations of all combinations of drivers and riders
					outputPanel.innerHTML += 'Driver__Riders__End__Miles__Minutes<br>___';
					for ( var i = 0; i < combos.length; i++ ) {
						for ( var j = 0; j <= list.length; j++ ) {
							outputPanel.innerHTML += combos[i].charAt(j) + '___';
							if ( j == list.length) { outputPanel.innerHTML += '_' + distance[i].toFixed(1) + '____' + duration[i].toFixed(1) + '<br>'; }
						}
						if ( i != (combos.length-1) ) { outputPanel.innerHTML += '___'; }
					}
					outputPanel.innerHTML += 'ADD SOLO ROUTE INFORMATION FOR EACH DRIVER<br>';
					outputPanel.innerHTML += 'Shortest route by distance is ' + combos[route_shortest_by_distance] + '<br>';
					outputPanel.innerHTML += 'Shortest route by duration is ' + combos[route_shortest_by_duration] + '<br>';
					outputPanel.innerHTML += 'Best driver is ' + combos[route_shortest_by_distance].charAt(0) + '<br>';
					outputPanel.innerHTML += 'Best route is ' + combos[route_shortest_by_distance] + ' (' + distance_shortest.toFixed(1) + ' miles in ' + duration_shortest.toFixed(1) + ' minutes).<br>';
					outputPanel.innerHTML += 'DISPLAY ALL SOLO ROUTES IN DIFFERENT COLORS<br>';

					//Calcuate distance and duration if riders drove alone
					var distance_solo = 0;
					var duration_solo = 0;
					for (var i = 0; i < origins.length; i++) {
						distance_solo = distance_solo + response.rows[i].elements[response.rows[i].elements.length-1].distance.value/1609.34;  //miles
						duration_solo = duration_solo + response.rows[i].elements[response.rows[i].elements.length-1].duration.value/60;  //minutes
					}
					outputPanel.innerHTML += 'If each driver drove separately, they would drive a total of ' + distance_solo.toFixed(1) + ' miles in ' + duration_solo.toFixed(1) + ' minutes.<br>';
					
					//Display detailed distance matrix information, if checkbox checked
					var details = document.getElementById('details_checkbox');
					if (details.checked) {
						for (var i = 0; i < origins.length; i++) {
          					for (var j = 0; j < response.rows[i].elements.length; j++) {
         	     				outputPanel.innerHTML += origins[i] + ' to ' + destinations[j] + ': ' + response.rows[i].elements[j].distance.text + ' in '
																+ response.rows[i].elements[j].duration.text + '<br>';
							}
            			}
          			}

					function permute(input) {  //Copyright 2007 Scriptar.com, All Rights Reserved. Author: Scriptar (scriptar@gmail.com)
						console.log('input is ',input);
						var i, ch, chars = input.split("");  //Convert input into a char array (one element for each character)
						for (i = 0; i < chars.length; i++) {
							console.log('Running permutation');
							ch = chars.splice(i, 1);  //Get and remove character at index "i" from char array
							usedChars.push(ch);  //Add removed character to the end of used characters
							if (chars.length == 0) combos[combos.length] = usedChars.join("");  //When there are no more characters left in char array to add, add used chars to list of permutations
							permute(chars.join(""));  //Send characters (minus the removed one from above) from char array to be permuted
							chars.splice(i, 0, ch);  //Add removed character back into char array in original position
							usedChars.pop();  //Remove the last character used off the end of used characters array
						}
						console.log('list inside permute function is ',list);
					}
					
				}
			}
		</script>
	</head>
	<body onload="initialize()">
		<div id="map" style="float:left;width:60%;height:100%;"></div>
		<div id="inputs" style="float:right;width:40%;text-align:left;padding-top:20px">
			<div style="margin:20px;border-width:2px;">
		    		<b>Carpool Route Optimizer v0.1</b><br>
				Written by James Harper<br><br>
				<b>Riders</b> <br>
    				<i>(Ctrl-Click for multiple selections)</i> <br>
		    		<select multiple id="riders">
					<option value="9765 Mesa Springs Way, 92126"> Aaron Andrews</input>
					<option value="6777 Saranac Street, 92115"> Jeff Beckman
					<option value="7150 Shoreline Drive #3314, 92122"> Ming Chuang</input>
		      		<option value="1030 Robinson Ave, 92103">Jennifer Fouquier</input>
		      		<option value="1122 Washington Place, 92103">James Harper</input>
		      		<option value="7245 Canyon Breeze Road, 92126">Elise Minda</input>
					<option value="3819 Miramar Street, 92037">Anais Orsi</input>
					<option value="960 Bolex Way, 92078">  Erin Rist
					<option value="3009 Union Street #18, 92103">Tony Rolfe</input>
		      		<option value="10711 Calston Way, 92126">Nazli Taheri</input>
		    		</select>
				<br><br>
		    		<b>Destination:</b>
		    		<select id="end">
		      		<option value="Mission Trails Visitor Center, 92119">Mission Trails Visitor Center</option>
		      		<option value="San Ysidro Border, Bursátil, Tijuana, Mexico">Tijuana</option>
		      		<option value="Ocean Beach, CA">Ocean Beach</option>
		      		<option value="4545 La Jolla Village Drive, 92122">UTC</option>
		    		</select>
		    		<br><br>
				<input type="checkbox" id="details_checkbox"/> Display detailed distance information
				<br><br>
		      	<button type="button" onclick="calculateDistances();">Calculate best driver and route</button>
				<br>
				ADD RESET BUTTON HERE
				<br><br>
    			</div>
    			<div id="directions_panel" style="margin:20px;background-color:#FFEE77;"></div>
    			<div id="output_panel" style="margin:20px;background-color:#FFEE77;"></div>
		</div>
	</body>
</html>